{% extends 'base.html' %}

{% load static %}

{% block header %}

<nav class="nav nav-masthead justify-content-center float-md-end">
    <a class="nav-link fw-bold py-1 px-0 "aria-label ="Home Page" aria-current="page" href="{% url 'home-page' %}">Browse-Logged-In</a>
    <a class="nav-link fw-bold py-1 px-0" aria-label="Logout" href="{% url 'account_logout' %}">Log Out</a>
</nav>

{% endblock %}

{% block index-page-exclusive %}

<div class="container">
  <div class="row">
      <div class="col-md-8 offset-md-2">
        {% block message %}
        {% endblock %}
      </div>
{% endblock %}

{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/quote-form.css' %}">
{% endblock extra_css %}

<!-- START OF Ticket REQUESTS SECTION -->

<div class="container-fluid">
    <div class="row">
      <div class="col center-my-text black-text h2-spacing">
        <h2>My Tickets</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 text-center full-width">
        <p class="d-inline-flex gap-1">
          <button class="btn btn-primary client-buttons" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample1" aria-expanded="false" aria-controls="collapseExample1" id="submitTicketButton">
            Create Ticket Request
          </button>
        </p>
        <div class="collapse black-font-color" id="collapseExample1">
          <div class="container-contact100 image-overlay-form">
            <div class="wrap-contact100">
                <form class="contact100-form validate-form" method="POST" action="#" id="ticket-form">
                    {% csrf_token %}
                    <span class="contact100-form-title">Create A Ticket</span>
                  
                    <!-- FULL NAME/COMPANY NAME Field -->
                    <div class="wrap-input100 validate-input bg1">
                      {{ form.full_nameORcompany_name.label_tag }}
                      {{ form.full_nameORcompany_name }}
                    </div>
                  
                    <!-- Time Requested Field -->
                    <div class="wrap-input100 validate-input bg1">
                      {{ form.time_requested.label_tag }}
                      {{ form.time_requested }}
                    </div>
                  
                    <!-- Description Field -->
                    <div class="wrap-input100 validate-input bg1">
                      {{ form.description.label_tag }}
                      {{ form.description }}
                    </div>
                  
                    <div class="container-contact100-form-btn">
                      <button class="contact100-form-btn">
                        <span>Submit <i class="fa fa-long-arrow-right m-l-7" aria-hidden="true"></i></span>
                      </button>
                    </div>
                  </form>                  
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid mt-3 client-container-styling">
        <div class="row">
            {% for ticket in answered_client_ticket_request  %}
            <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="card client-card-styling">
                    <div class="card-header">
                        <h5 class="card-title">{{ ticket.full_nameORcompany_name }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ ticket.time_requested }}</h6>
                        <span class="badge bg-primary">Status:{{ ticket.status }} </span> <a class="right-align close-ticket-styling" onclick="closeTicket(event, {{ quote.id }})">Close Ticket ?</a>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <span class="short-description">{{ ticket.request_description|truncatechars:50 }}</span>
                            <span class="full-description" style="display: none;">{{ ticket.request_description }}</span>
                        </p>
                        <a href="#" class="card-link toggle-text">Read more</a>
                    </div>
                    <div class="card-footer client-card-footer-styling client-custom-footer">
                        <a href="#" class="btn btn-primary">View/Reply</a>
                    </div>
                </div>
            </div>
        {% endfor %}
            {% for ticket in unanswered_client_ticket_request %}
                <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                    <div class="card client-card-styling">
                        <div class="card-header">
                            <h5 class="card-title">{{ ticket.full_nameORcompany_name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ ticket.time_requested }}</h6>
                            <span class="badge bg-success">Status:{{ ticket.status }} </span> 
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <span class="short-description">{{ ticket_description|truncatechars:50 }}</span>
                                <span class="full-description" style="display: none;">{{ ticket.request_description }}</span>
                            </p>
                            <a href="#" class="card-link toggle-text">Read more</a>
                        </div>
                        <div class="card-footer client-card-footer-styling client-custom-footer">
                            <a href="{% url 'view-ticket' ticket.id %}" class="btn btn-success">View</a>
                            <a href="{% url 'edit-ticket' ticket.id %}" class="btn btn-success">Edit</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
  </div>
  <div class="container d-flex justify-content-center">
  <button class="closed-quotes-custom-btn" id="toggleClosedQuotes">Show Closed Tickets</button>
  </div>
  <div class="container-fluid client-container-styling">
      <div class="row">
          <div id="closedQuotesSection"  style="display: none;"> 
              {% for quote in closed_quotes %}
                  <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                      <div class="card client-card-styling">
                          <div class="card-header">
                              <h5 class="card-title">{{ quote.full_nameORcompany_name }}</h5>
                              <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ quote.time_requested }}</h6>
                              <h6 class="card-subtitle mb-2 text-muted client-date-styling">Closed By: {{ quote.get_service_display }}</h6>
                              <span class="badge bg-danger">Status: {{ quote.status }}</span>
                          </div>
                          <div class="card-body">
                              <p class="card-text">
                                  <span class="short-description">{{ quote.request_description|truncatechars:50 }}</span>
                                  <span class="full-description" style="display: none;">{{ quote.request_description }}</span>
                              </p>
                              <a href="#" class="card-link toggle-text">Read more</a>
                          </div>
                          <div class="card-footer client-card-footer-styling client-custom-footer">
                              <a href="#" class="btn btn-primary">Re-open ?</a>
                          </div>
                      </div>
                  </div>
              {% endfor %}
          </div>
      </div> 
  </div>
</div>
  
<!-- 
<div class="container-fluid">
    <div class="col center-my-text black-text h2-spacing">
        <h2>My Tickets</h2>
    </div>
</div>

<div class="container-fluid">
        <button class="btn btn-primary client-buttons center-my-text black-text h2-spacing" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample1" aria-expanded="false" aria-controls="collapseExample1" id="submitTicketButton">
          Create Ticket Request
        </button>
</div>

<div class="collapse black-font-color" id="collapseExample1">
    <div class="container-contact100 image-overlay-form">
      <div class="wrap-contact100">
          <form class="contact100-form validate-form" method="POST" action="{% url 'submit_authorised_quote_request' %}" id="quote-form">
              {% csrf_token %}
              <span class="contact100-form-title">Request A Quote</span>
              <div class="wrap-input100 validate-input bg1" data-validate="Please Type Your Name">
                  <span class="label-input100">Quote Title <span class="important">*</span></span>
                  <input class="input100" type="text" name="full_nameORcompany_name" placeholder="Enter Your Name/Company Name" value="{{ user.username }}">
              </div>
              <div class="wrap-input100 validate-input bg1 rs1-wrap-input100" data-validate="Enter Your Email (e@a.x)">
                  <span class="label-input100">Email <span class="important">*</span></span>
                  <input class="input100" type="text" name="email" placeholder="Enter Your Email ">
              </div>
              <div class="wrap-input100 bg1 rs1-wrap-input100">
                  <span class="label-input100">Phone</span>
                  <input class="input100" type="text" name="phone" placeholder="Enter Number Phone">
              </div>
              <div class="wrap-input100 input100-select bg1">
                  <span class="label-input100">Needed Service <span class="important">*</span></span>
                  <div>
                      <select class="js-select2" name="service">
                          <option value="support">Support</option>
                          <option value="hardware">Hardware</option>
                          <option value="software">Software</option>
                          <option value="microsoft">Microsoft</option>
                          <option value="power_solutions">Power Solutions</option>
                      </select>
                  </div>
              </div>
              <div class="wrap-input100 validate-input bg0 rs1-alert-validate" data-validate="Please Type Your Message">
                  <span class="label-input100">Message</span>
                  <textarea class="input100" name="request_description" placeholder="Your message here..."></textarea>
              </div>
              <div class="container-contact100-form-btn">
                  <button class="contact100-form-btn">
                      <span>Submit <i class="fa fa-long-arrow-right m-l-7" aria-hidden="true"></i></span>
                  </button>
              </div>
          </form>
      </div>
  </div>
    </div>

<div class="container-fluid mt-3 client-container-styling">
    <div class="row">
        {% for quote in answered_quotes %}
            <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="card client-card-styling">
                    <div class="card-header">
                        <h5 class="card-title">{{ quote.full_nameORcompany_name }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ quote.time_requested }}</h6>
                        <h6 class="card-subtitle mb-2 text-muted client-date-styling">Type: {{ quote.get_service_display }}</h6>
                        <span class="badge bg-success">Status:{{ quote.status }} </span> <a class="right-align close-ticket-styling" onclick="closeTicket(event, {{ quote.id }})">Close Ticket ?</a>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <span class="short-description">{{ quote.request_description|truncatechars:50 }}</span>
                            <span class="full-description" style="display: none;">{{ quote.request_description }}</span>
                        </p>
                        <a href="#" class="card-link toggle-text">Read more</a>
                    </div>
                    <div class="card-footer client-card-footer-styling client-custom-footer">
                        <a href="{% url 'edit-quote-request' quote.id %}" class="btn btn-success">View Answer</a>
                    </div>
                </div>
            </div>
        {% endfor %}

        {% for quote in unanswered_quotes %}
            <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="card client-card-styling">
                    <div class="card-header">
                        <h5 class="card-title">{{ quote.full_nameORcompany_name }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ quote.time_requested }}</h6>
                        <h6 class="card-subtitle mb-2 text-muted client-date-styling">Type: {{ quote.get_service_display }}</h6>
                        <span class="badge bg-primary">Status:{{ quote.status }}</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <span class="short-description">{{ quote.request_description|truncatechars:50 }}</span>
                            <span class="full-description" style="display: none;">{{ quote.request_description }}</span>
                        </p>
                        <a href="#" class="card-link toggle-text">Read more</a>
                    </div>
                    <div class="card-footer client-card-footer-styling client-custom-footer">
                        <a href="{% url 'edit-quote-request' quote.id %}" class="btn btn-primary">View/Edit</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div> -->






















    <!-- START OF QUOTE REQUESTS SECTION -->

    <div class="create-some-space"></div>
      <div class="container-fluid">
        <div class="row">
            <div class="col center-my-text black-text h2-spacing">
                <h2>QUOTE REQUESTS</h2>
            </div>
          <div class="col-md-6 text-center full-width">
            <button class="btn btn-primary client-buttons" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample1" aria-expanded="false" aria-controls="collapseExample1" id="submitTicketButton">
                Create Quote Request
              </button>
            <div class="collapse black-font-color" id="collapseExample">
              <div class="container-contact100 image-overlay-form">
                <div class="wrap-contact100">
                    <form class="contact100-form validate-form" method="POST" action="{% url 'submit_authorised_quote_request' %}" id="quote-form">
                        {% csrf_token %}
                        <span class="contact100-form-title">Request A Quote</span>
                        <div class="wrap-input100 validate-input bg1" data-validate="Please Type Your Name">
                            <span class="label-input100">Quote Title <span class="important">*</span></span>
                            <input class="input100" type="text" name="full_nameORcompany_name" placeholder="Enter Your Name/Company Name" value="{{ user.username }}">
                        </div>
                        <div class="wrap-input100 validate-input bg1 rs1-wrap-input100" data-validate="Enter Your Email (e@a.x)">
                            <span class="label-input100">Email <span class="important">*</span></span>
                            <input class="input100" type="text" name="email" placeholder="Enter Your Email ">
                        </div>
                        <div class="wrap-input100 bg1 rs1-wrap-input100">
                            <span class="label-input100">Phone</span>
                            <input class="input100" type="text" name="phone" placeholder="Enter Number Phone">
                        </div>
                        <div class="wrap-input100 input100-select bg1">
                            <span class="label-input100">Needed Service <span class="important">*</span></span>
                            <div>
                                <select class="js-select2" name="service">
                                    <option value="support">Support</option>
                                    <option value="hardware">Hardware</option>
                                    <option value="software">Software</option>
                                    <option value="microsoft">Microsoft</option>
                                    <option value="power_solutions">Power Solutions</option>
                                </select>
                            </div>
                        </div>
                        <div class="wrap-input100 validate-input bg0 rs1-alert-validate" data-validate="Please Type Your Message">
                            <span class="label-input100">Message</span>
                            <textarea class="input100" name="request_description" placeholder="Your message here..."></textarea>
                        </div>
                        <div class="container-contact100-form-btn">
                            <button class="contact100-form-btn">
                                <span>Submit <i class="fa fa-long-arrow-right m-l-7" aria-hidden="true"></i></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
              </div>
            </div>
          </div>
        </div>



      <div class="container-fluid mt-3 client-container-styling">
        <div class="row">
            {% for quote in answered_quotes %}
                <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                    <div class="card client-card-styling">
                        <div class="card-header">
                            <h5 class="card-title">{{ quote.full_nameORcompany_name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ quote.time_requested }}</h6>
                            <h6 class="card-subtitle mb-2 text-muted client-date-styling">Type: {{ quote.get_service_display }}</h6>
                            <span class="badge bg-success">Status:{{ quote.status }} </span> <a class="right-align close-ticket-styling" onclick="closeTicket(event, {{ quote.id }})">Close Ticket ?</a>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <span class="short-description">{{ quote.request_description|truncatechars:50 }}</span>
                                <span class="full-description" style="display: none;">{{ quote.request_description }}</span>
                            </p>
                            <a href="#" class="card-link toggle-text">Read more</a>
                        </div>
                        <div class="card-footer client-card-footer-styling client-custom-footer">
                            <a href="{% url 'edit-quote-request' quote.id %}" class="btn btn-success">View Answer</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
    
            {% for quote in unanswered_quotes %}
                <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                    <div class="card client-card-styling">
                        <div class="card-header">
                            <h5 class="card-title">{{ quote.full_nameORcompany_name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ quote.time_requested }}</h6>
                            <h6 class="card-subtitle mb-2 text-muted client-date-styling">Type: {{ quote.get_service_display }}</h6>
                            <span class="badge bg-primary">Status:{{ quote.status }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <span class="short-description">{{ quote.request_description|truncatechars:50 }}</span>
                                <span class="full-description" style="display: none;">{{ quote.request_description }}</span>
                            </p>
                            <a href="#" class="card-link toggle-text">Read more</a>
                        </div>
                        <div class="card-footer client-card-footer-styling client-custom-footer">
                            <a href="{% url 'edit-quote-request' quote.id %}" class="btn btn-primary">View/Edit</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
        <div class="container d-flex justify-content-center">
            <button class="closed-quotes-custom-btn" id="toggleClosedQuotes">Show Closed Quotes</button>
        </div>
        <div class="container-fluid client-container-styling">
            <div class="row">
                <div id="closedQuotesSection"  style="display: none;"> 
                    {% for quote in closed_quotes %}
                        <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                            <div class="card client-card-styling">
                                <div class="card-header">
                                    <h5 class="card-title">{{ quote.full_nameORcompany_name }}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted client-date-styling">Date Created: {{ quote.time_requested }}</h6>
                                    <h6 class="card-subtitle mb-2 text-muted client-date-styling">Closed By: {{ quote.get_service_display }}</h6>
                                    <span class="badge bg-danger">Status: {{ quote.status }}</span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <span class="short-description">{{ quote.request_description|truncatechars:50 }}</span>
                                        <span class="full-description" style="display: none;">{{ quote.request_description }}</span>
                                    </p>
                                    <a href="#" class="card-link toggle-text">Read more</a>
                                </div>
                                <div class="card-footer client-card-footer-styling client-custom-footer">
                                    <a href="{% url 'edit-quote-request' quote.id %}" class="btn btn-primary">Re-open ?</a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div> 
        </div>
    
<script>
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
    function closeTicket(event, quoteId) {
        event.preventDefault(); // Prevent the default link behavior

        // Create a form programmatically
        var form = document.createElement('form');
        form.style.display = 'none'; // Hide the form
        form.method = 'POST';
        form.action = `{% url 'close-client-ticket' 0 %}`.replace('/0/', `/${quoteId}/`); // Dynamically set the action URL

        // Add CSRF token from cookie
        var csrfToken = getCookie('csrftoken');
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit(); // Submit the form
        }
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll('.toggle-text').forEach(function(btn) {
                btn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const cardBody = event.target.closest('.card-body');
                    const fullText = cardBody.querySelector('.full-description');
                    const shortText = cardBody.querySelector('.short-description');
    
                    if (fullText.style.display === "none") {
                        fullText.style.display = "inline";
                        shortText.style.display = "none";
                        event.target.textContent = "Read less";
                    } else {
                        fullText.style.display = "none";
                        shortText.style.display = "inline";
                        event.target.textContent = "Read more";
                    }
                });
            });
    
            const toggleClosedQuotesBtn = document.getElementById('toggleClosedQuotes');
            const closedQuotesSection = document.getElementById('closedQuotesSection');
    
            toggleClosedQuotesBtn.addEventListener('click', function() {
                const isHidden = closedQuotesSection.style.display === "none" || closedQuotesSection.style.display === "";
                closedQuotesSection.style.display = isHidden ? "flex" : "none"; // This line toggles between flex and none
                toggleClosedQuotesBtn.textContent = isHidden ? "Hide Closed Quotes" : "Show Closed Quotes";
            });
        });
        function closeAlert() {
            let messages = document.getElementById("msg");
            if (messages) {
                let alert = new bootstrap.Alert(messages);
                alert.close();
            }
        }
        setTimeout(closeAlert, 4000);
    </script>

{% endblock content %}
